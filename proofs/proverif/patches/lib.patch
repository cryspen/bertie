--- proofs/proverif/extraction/lib.pvl	2024-04-04 09:14:35.030178542 +0200
+++ proofs/proverif/extraction/lib_latest.pvl	2024-04-04 09:14:12.563561849 +0200
@@ -20,7 +20,7 @@
 fun nat_to_bitstring(nat): bitstring.
 
 letfun bool_default() = false.
-
+event Reachable_simple.
 
 (*****************************************)
 (* Types and Constructors *)
@@ -486,26 +486,9 @@
       t13__tls13utils__t_Bytes, t13__tls13utils__t_Bytes
     )
     : t13__tls13crypto__t_RsaVerificationKey [data].
-reduc forall 
-  t13__tls13crypto__RsaVerificationKey_f_modulus: t13__tls13utils__t_Bytes,
-  t13__tls13crypto__RsaVerificationKey_f_exponent: t13__tls13utils__t_Bytes
-;
-    accessor_t13__tls13crypto__RsaVerificationKey_f_modulus(
-      t13__tls13crypto__RsaVerificationKey_c(
-        t13__tls13crypto__RsaVerificationKey_f_modulus,
-        t13__tls13crypto__RsaVerificationKey_f_exponent
-      )
-    ) = t13__tls13crypto__RsaVerificationKey_f_modulus.
-reduc forall 
-  t13__tls13crypto__RsaVerificationKey_f_modulus: t13__tls13utils__t_Bytes,
-  t13__tls13crypto__RsaVerificationKey_f_exponent: t13__tls13utils__t_Bytes
-;
-    accessor_t13__tls13crypto__RsaVerificationKey_f_exponent(
-      t13__tls13crypto__RsaVerificationKey_c(
-        t13__tls13crypto__RsaVerificationKey_f_modulus,
-        t13__tls13crypto__RsaVerificationKey_f_exponent
-      )
-    ) = t13__tls13crypto__RsaVerificationKey_f_exponent.
+
+
+
 
 type t13__tls13crypto__t_PublicVerificationKey.
 
@@ -2125,6 +2108,9 @@
 
 type t13__tls13record__t_DuplexCipherState1.
 
+event ClientFinished(t13__tls13utils__t_Bytes,t13__tls13record__t_DuplexCipherState1, t13__tls13handshake__t_ClientPostClientFinished).
+event ServerFinished(t13__tls13utils__t_Bytes,t13__tls13record__t_DuplexCipherState1, t13__tls13handshake__t_ServerPostServerFinished).
+
 fun t13__tls13record__t_DuplexCipherState1_to_bitstring(
       t13__tls13record__t_DuplexCipherState1
     )
@@ -2447,22 +2433,30 @@
 letfun t13__tls13utils__parse_failed(wildcard1 : bitstring) =
        t13__tls13utils__v_PARSE_FAILED.
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13utils__u16_as_be_bytes(val : nat) =
-       bitstring_default().
+(* MARKER: tls13utils models*)
+fun t13__tls13utils__u16_as_be_bytes(nat)
+    : t13__tls13utils__t_Bytes [data].
+
+letfun t13__tls13utils__eq(
+         b1 : t13__tls13utils__t_Bytes, b2 : t13__tls13utils__t_Bytes
+       ) =
+       b1 = b2. (* This is term equality, which may not be what we want? *)
+
+fun t13__tls13utils__check_eq(t13__tls13utils__t_Bytes, t13__tls13utils__t_Bytes): bitstring
+reduc forall b1 : t13__tls13utils__t_Bytes;
+      t13__tls13utils__check_eq(b1,b1) = ().
+
+fun t13__tls13utils__impl__Bytes__concat(t13__tls13utils__t_Bytes, t13__tls13utils__t_Bytes): t13__tls13utils__t_Bytes [data].
+
+letfun t13__tls13utils__impl__Bytes__prefix(self:t13__tls13utils__t_Bytes, prefix:t13__tls13utils__t_Bytes)
+=
+       t13__tls13utils__impl__Bytes__concat(prefix, self).
+(* MARKER: tls13utils models end*)
+
 
 letfun t13__tls13crypto__impl__HashAlgorithm__hash_len(
          self : t13__tls13crypto__t_HashAlgorithm
-       ) =
-       let t13__tls13crypto__HashAlgorithm_HashAlgorithm_SHA256_c() = self in libcrux__digest__digest_size(
-         libcrux__digest__Algorithm_Algorithm_Sha256_c()
-       )
-       else let t13__tls13crypto__HashAlgorithm_HashAlgorithm_SHA384_c() = self in libcrux__digest__digest_size(
-         libcrux__digest__Algorithm_Algorithm_Sha384_c()
-       )
-       else let t13__tls13crypto__HashAlgorithm_HashAlgorithm_SHA512_c() = self in libcrux__digest__digest_size(
-         libcrux__digest__Algorithm_Algorithm_Sha512_c()
-       ).
+       ) = 0.
 
 letfun t13__tls13crypto__impl__HashAlgorithm__hmac_tag_len(
          self : t13__tls13crypto__t_HashAlgorithm
@@ -2489,22 +2483,6 @@
        ) =
        accessor_t13__tls13crypto__Algorithms_f_signature(self).
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13cert__verification_key_from_cert(
-         cert : t13__tls13utils__t_Bytes
-       ) =
-       bitstring_default().
-
-(* marked as constructor *)
-fun t13__tls13crypto__sign_rsa(
-      t13__tls13utils__t_Bytes,
-      t13__tls13utils__t_Bytes,
-      t13__tls13utils__t_Bytes,
-      t13__tls13crypto__t_SignatureScheme,
-      t13__tls13utils__t_Bytes,
-      impl_CryptoRng___RngCore
-    )
-    : bitstring [data].
 
 (* marked as constructor *)
 fun t13__tls13crypto__impl__HashAlgorithm__hash(
@@ -2535,56 +2513,13 @@
       t13__tls13utils__t_Bytes,
       t13__tls13utils__t_Bytes
     )
-    : t13__tls13utils__t_Bytes [data].
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13crypto__kem_decap(
-         alg : t13__tls13crypto__t_KemScheme,
-         ct : t13__tls13utils__t_Bytes,
-         sk : t13__tls13utils__t_Bytes
-       ) =
-       t13__tls13utils__t_Bytes_default().
+    : t13__tls13utils__t_Bytes.
 
 letfun t13__tls13utils__impl__Bytes__as_raw(
          self : t13__tls13utils__t_Bytes
        ) =
        accessor_t13__tls13utils__Bytes_0(self).
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13utils__impl__Bytes__prefix(
-         self : t13__tls13utils__t_Bytes, prefix : bitstring
-       ) =
-       t13__tls13utils__t_Bytes_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13utils__impl__Bytes__concat(
-         self : t13__tls13utils__t_Bytes, other : t13__tls13utils__t_Bytes
-       ) =
-       t13__tls13utils__t_Bytes_default().
-
-(* marked as constructor *)
-fun t13__tls13crypto__kem_encap(
-      t13__tls13crypto__t_KemScheme,
-      t13__tls13utils__t_Bytes,
-      impl_CryptoRng___RngCore
-    )
-    : bitstring [data].
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13crypto__kem_keygen(
-         alg : t13__tls13crypto__t_KemScheme, rng : impl_CryptoRng___RngCore
-       ) =
-       bitstring_default().
-
-(* marked as constructor *)
-fun t13__tls13crypto__sign(
-      t13__tls13crypto__t_SignatureScheme,
-      t13__tls13utils__t_Bytes,
-      t13__tls13utils__t_Bytes,
-      impl_CryptoRng___RngCore
-    )
-    : bitstring [data].
-
 letfun t13__tls13utils__impl__Bytes__from_slice(s : bitstring) =
        t13__tls13utils__t_Bytes_from_bitstring(s).
 
@@ -2611,52 +2546,23 @@
 letfun t13__tls13utils__bytes(x : bitstring) =
        t13__tls13utils__t_Bytes_from_bitstring(x).
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13utils__check_eq(
-         b1 : t13__tls13utils__t_Bytes, b2 : t13__tls13utils__t_Bytes
-       ) =
-       bitstring_default().
-
 (* marked as constructor *)
 fun t13__tls13utils__encode_length_u8(bitstring)
     : t13__tls13utils__t_Bytes [data].
 
-letfun t13__tls13handshake__hkdf_expand_label(
-         hash_algorithm : t13__tls13crypto__t_HashAlgorithm,
-         key : t13__tls13utils__t_Bytes,
-         label : t13__tls13utils__t_Bytes,
-         context : t13__tls13utils__t_Bytes,
-         len : nat
-       ) =
-       if core__cmp__PartialOrd__ge(len, 65536)
-       then (t13__tls13utils__t_Bytes_err())
-       else (
-         let lenb =
-           t13__tls13utils__u16_as_be_bytes(t13__tls13utils__v_U16(len))
-          in
-         let tls13_label =
-           t13__tls13utils__impl__Bytes__concat(
-             t13__tls13utils__impl__Bytes__from_slice(
-               t13__tls13formats__v_LABEL_TLS13
-             ),
-             label
-           )
-          in
-         let hoist27 = t13__tls13utils__encode_length_u8(
-           t13__tls13utils__impl__Bytes__as_raw(tls13_label)
-         ) in let hoist26 = t13__tls13utils__encode_length_u8(
-           t13__tls13utils__impl__Bytes__as_raw(context)
-         ) in (
-           let hoist28 =
-             t13__tls13utils__impl__Bytes__concat(hoist27, hoist26)
-            in
-           let info = t13__tls13utils__impl__Bytes__prefix(hoist28, lenb) in
-           t13__tls13crypto__hkdf_expand(hash_algorithm, key, info, len)
-         )
-         else t13__tls13utils__t_Bytes_err()
-         else t13__tls13utils__t_Bytes_err()
-       ).
+fun expand_label_inner(t13__tls13crypto__t_HashAlgorithm,
+         t13__tls13utils__t_Bytes,
+         t13__tls13utils__t_Bytes,
+         t13__tls13utils__t_Bytes): t13__tls13utils__t_Bytes [data].
 
+letfun t13__tls13handshake__hkdf_expand_label(
+         hash_algorithm: t13__tls13crypto__t_HashAlgorithm,
+         key: t13__tls13utils__t_Bytes,
+         label: t13__tls13utils__t_Bytes,
+         input: t13__tls13utils__t_Bytes,
+         length: nat
+       ) = expand_label_inner(hash_algorithm, key, label, input).
+       
 letfun t13__tls13handshake__derive_finished_key(
          ha : t13__tls13crypto__t_HashAlgorithm,
          k : t13__tls13utils__t_Bytes
@@ -2710,21 +2616,6 @@
          tx
        ).
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13utils__eq(
-         b1 : t13__tls13utils__t_Bytes, b2 : t13__tls13utils__t_Bytes
-       ) =
-       bool_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13crypto__hmac_verify(
-         alg : t13__tls13crypto__t_HashAlgorithm,
-         mk : t13__tls13utils__t_Bytes,
-         input : t13__tls13utils__t_Bytes,
-         tag : t13__tls13utils__t_Bytes
-       ) =
-       bitstring_default().
-
 letfun t13__server__lookup_db(
          ciphersuite : t13__tls13crypto__t_Algorithms,
          db : t13__server__t_ServerDB,
@@ -2791,39 +2682,264 @@
     )
     : t13__tls13crypto__t_RsaVerificationKey [data].
 
-(* REPLACE by handwritten model *)
+(* MARKER: tls13cert models*)
+fun t13__tls13cert__ecdsa_public_key(t13__tls13utils__t_Bytes, t13__tls13cert__t_CertificateKey): t13__tls13utils__t_Bytes.
+fun spki(t13__tls13crypto__t_SignatureScheme,
+         t13__tls13cert__t_CertificateKey):  t13__tls13utils__t_Bytes [data].
+
+fun certificate(t13__tls13utils__t_Bytes, t13__tls13utils__t_Bytes, t13__tls13crypto__t_PublicVerificationKey): t13__tls13utils__t_Bytes [private].
+
+reduc forall
+      server_name: t13__tls13utils__t_Bytes,
+      spki:t13__tls13utils__t_Bytes,
+      cert_pk: t13__tls13crypto__t_PublicVerificationKey;
+      cert_verify(server_name, certificate(server_name, spki, cert_pk))
+      = certificate(server_name, spki, cert_pk).
+
+
 letfun t13__tls13cert__cert_public_key(
+         server_name: t13__tls13utils__t_Bytes,
          certificate : t13__tls13utils__t_Bytes, spki : bitstring
        ) =
-       t13__tls13crypto__t_PublicVerificationKey_default().
+       let certificate = cert_verify(server_name, certificate) in
+       let (scheme: t13__tls13crypto__t_SignatureScheme, pk: t13__tls13cert__t_CertificateKey) = spki in
+       let t13__tls13crypto__SignatureScheme_SignatureScheme_ED25519_c() = scheme in
+       t13__tls13crypto__t_PublicVerificationKey_err()
+       else let t13__tls13crypto__SignatureScheme_SignatureScheme_EcdsaSecp256r1Sha256_c(
+
+       ) = scheme in let pk = t13__tls13cert__ecdsa_public_key(
+         certificate, pk
+       ) in t13__tls13crypto__PublicVerificationKey_PublicVerificationKey_EcDsa_c(
+         pk
+       )
+       else t13__tls13crypto__t_PublicVerificationKey_err()
+       else let t13__tls13crypto__SignatureScheme_SignatureScheme_RsaPssRsaSha256_c(
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13crypto__verify(
-         alg : t13__tls13crypto__t_SignatureScheme,
-         pk : t13__tls13crypto__t_PublicVerificationKey,
-         input : t13__tls13utils__t_Bytes,
-         sig : t13__tls13utils__t_Bytes
+       ) = scheme in let pk = t13__tls13cert__rsa_public_key(
+         certificate, pk
+       ) in t13__tls13crypto__PublicVerificationKey_PublicVerificationKey_Rsa_c(
+         pk
+       )
+       else t13__tls13crypto__t_PublicVerificationKey_err().
+
+      
+reduc forall server_name: t13__tls13utils__t_Bytes, alg: t13__tls13crypto__t_SignatureScheme, cert_key_slice: t13__tls13cert__t_CertificateKey, cert_key: t13__tls13crypto__t_PublicVerificationKey;
+  t13__tls13cert__verification_key_from_cert(
+            certificate(server_name, spki(alg, cert_key_slice), cert_key) 
        ) =
-       bitstring_default().
+       (alg, cert_key_slice).
+(* MARKER: tls13cert models end*)
 
-(* marked as constructor *)
-fun t13__tls13formats__handshake_data__impl__HandshakeData__concat(
-      t13__tls13formats__handshake_data__t_HandshakeData,
-      t13__tls13formats__handshake_data__t_HandshakeData
+(* MARKER: tls13crypto models*)
+fun vk_from_sk(t13__tls13utils__t_Bytes): t13__tls13crypto__t_PublicVerificationKey.
+fun rsa_vk_from_sk(t13__tls13utils__t_Bytes,t13__tls13utils__t_Bytes,t13__tls13utils__t_Bytes): t13__tls13crypto__t_PublicVerificationKey.
+fun rsa_modulus_from_sk(t13__tls13utils__t_Bytes): t13__tls13utils__t_Bytes.
+const RSA_PUBLIC_EXPONENT: t13__tls13utils__t_Bytes.
+
+fun ecdsa_cert_key_slice(): t13__tls13cert__t_CertificateKey.
+fun rsa_cert_key_slice(): t13__tls13cert__t_CertificateKey.
+
+
+fun accessor_t13__tls13crypto__RsaVerificationKey_f_modulus(t13__tls13crypto__t_RsaVerificationKey): t13__tls13utils__t_Bytes
+reduc forall 
+  t13__tls13crypto__RsaVerificationKey_f_modulus: t13__tls13utils__t_Bytes,
+  t13__tls13crypto__RsaVerificationKey_f_exponent: t13__tls13utils__t_Bytes
+;
+    accessor_t13__tls13crypto__RsaVerificationKey_f_modulus(
+      t13__tls13crypto__RsaVerificationKey_c(
+        t13__tls13crypto__RsaVerificationKey_f_modulus,
+        t13__tls13crypto__RsaVerificationKey_f_exponent
+      )
+    ) = t13__tls13crypto__RsaVerificationKey_f_modulus
+otherwise
+    forall server_name: t13__tls13utils__t_Bytes,
+           sk: t13__tls13utils__t_Bytes,
+           modulus: t13__tls13utils__t_Bytes,
+           exponent: t13__tls13utils__t_Bytes,
+           key_slice: t13__tls13cert__t_CertificateKey;
+    accessor_t13__tls13crypto__RsaVerificationKey_f_modulus(    t13__tls13cert__rsa_public_key(
+        certificate(server_name,
+                    spki(t13__tls13crypto__SignatureScheme_SignatureScheme_RsaPssRsaSha256_c,
+                         key_slice),
+                    rsa_vk_from_sk(sk,
+                                   modulus,
+                    exponent)),
+                    key_slice)) = modulus.
+
+fun accessor_t13__tls13crypto__RsaVerificationKey_f_exponent(t13__tls13crypto__t_RsaVerificationKey): t13__tls13utils__t_Bytes
+reduc forall 
+  t13__tls13crypto__RsaVerificationKey_f_modulus: t13__tls13utils__t_Bytes,
+  t13__tls13crypto__RsaVerificationKey_f_exponent: t13__tls13utils__t_Bytes
+;
+    accessor_t13__tls13crypto__RsaVerificationKey_f_exponent(
+      t13__tls13crypto__RsaVerificationKey_c(
+        t13__tls13crypto__RsaVerificationKey_f_modulus,
+        t13__tls13crypto__RsaVerificationKey_f_exponent
+      )
+    ) = t13__tls13crypto__RsaVerificationKey_f_exponent
+    otherwise
+    forall server_name: t13__tls13utils__t_Bytes,
+           sk: t13__tls13utils__t_Bytes,
+           modulus: t13__tls13utils__t_Bytes,
+           exponent: t13__tls13utils__t_Bytes,
+           key_slice: t13__tls13cert__t_CertificateKey;
+    accessor_t13__tls13crypto__RsaVerificationKey_f_exponent(    t13__tls13cert__rsa_public_key(
+        certificate(server_name,
+                    spki(t13__tls13crypto__SignatureScheme_SignatureScheme_RsaPssRsaSha256_c,
+                         key_slice),
+                    rsa_vk_from_sk(sk,
+                                   modulus,
+                    exponent)),
+                    key_slice)) = exponent.
+
+    
+fun sign_inner(
+      t13__tls13crypto__t_SignatureScheme,
+      t13__tls13utils__t_Bytes,
+      t13__tls13utils__t_Bytes
     )
-    : t13__tls13formats__handshake_data__t_HandshakeData [data].
+    : t13__tls13utils__t_Bytes.
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__handshake_data__impl__HandshakeData__to_four(
-         self : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       bitstring_default().
+letfun t13__tls13crypto__sign(
+      alg:t13__tls13crypto__t_SignatureScheme,
+      sk: t13__tls13utils__t_Bytes,
+      input: t13__tls13utils__t_Bytes,
+      rng: impl_CryptoRng___RngCore)
+      =
+      (rng,
+        sign_inner(
+        alg,
+        sk,
+        input
+      )).
+
+fun sign_inner_rsa(
+      t13__tls13utils__t_Bytes,
+      t13__tls13utils__t_Bytes,
+      t13__tls13utils__t_Bytes,
+      t13__tls13crypto__t_SignatureScheme,
+      t13__tls13utils__t_Bytes
+    )
+    : t13__tls13utils__t_Bytes.
+
+letfun t13__tls13crypto__sign_rsa(
+      sk: t13__tls13utils__t_Bytes,
+      pk_modulus: t13__tls13utils__t_Bytes,
+      pk_exponent: t13__tls13utils__t_Bytes,
+      cert_scheme: t13__tls13crypto__t_SignatureScheme,
+      input: t13__tls13utils__t_Bytes,
+      rng: impl_CryptoRng___RngCore
+    )
+    =
+    (rng,
+        sign_inner_rsa(
+          sk,
+          pk_modulus,
+          pk_exponent,
+          cert_scheme,
+          input)
+    ).
+
+fun t13__tls13crypto__verify(
+        t13__tls13crypto__t_SignatureScheme,
+        t13__tls13crypto__t_PublicVerificationKey,
+        t13__tls13utils__t_Bytes,
+        t13__tls13utils__t_Bytes
+        )
+    : bitstring
+  reduc
+    forall server_name: t13__tls13utils__t_Bytes,
+           sk: t13__tls13utils__t_Bytes,
+           cert_scheme: t13__tls13crypto__t_SignatureScheme,
+           input: t13__tls13utils__t_Bytes,
+           rng: impl_CryptoRng___RngCore;
+      t13__tls13crypto__verify(
+        t13__tls13crypto__SignatureScheme_SignatureScheme_RsaPssRsaSha256_c(),
+
+        t13__tls13crypto__PublicVerificationKey_PublicVerificationKey_Rsa_c(
+            t13__tls13cert__rsa_public_key(
+                certificate(server_name,
+                    spki(t13__tls13crypto__SignatureScheme_SignatureScheme_RsaPssRsaSha256_c,rsa_cert_key_slice),
+                    rsa_vk_from_sk(sk,rsa_modulus_from_sk(sk),RSA_PUBLIC_EXPONENT)),
+                    rsa_cert_key_slice)),
+        input,
+        sign_inner_rsa(sk, rsa_modulus_from_sk(sk), RSA_PUBLIC_EXPONENT, cert_scheme, input)
+      ) = ()
+  otherwise
+    forall server_name: t13__tls13utils__t_Bytes,
+           sk: t13__tls13utils__t_Bytes,
+           input: t13__tls13utils__t_Bytes,
+           rng: impl_CryptoRng___RngCore;
+      t13__tls13crypto__verify(
+        t13__tls13crypto__SignatureScheme_SignatureScheme_EcdsaSecp256r1Sha256_c,
+        t13__tls13crypto__PublicVerificationKey_PublicVerificationKey_EcDsa_c(
+            t13__tls13cert__ecdsa_public_key(
+                certificate(server_name,
+                    spki(t13__tls13crypto__SignatureScheme_SignatureScheme_EcdsaSecp256r1Sha256_c,ecdsa_cert_key_slice),
+                    vk_from_sk(sk)),
+                ecdsa_cert_key_slice)),
+        input,
+        sign_inner(t13__tls13crypto__SignatureScheme_SignatureScheme_EcdsaSecp256r1Sha256_c, sk, input)
+      ) = ().
+
+reduc
+  forall
+         alg : t13__tls13crypto__t_HashAlgorithm,
+         mk : t13__tls13utils__t_Bytes,
+         input : t13__tls13utils__t_Bytes;
+         t13__tls13crypto__hmac_verify(
+            alg,
+            mk,
+            input,
+            t13__tls13crypto__hmac_tag(alg, mk, input)
+         ) = ().
+
+fun kem_pk_from_sk(t13__tls13utils__t_Bytes): t13__tls13utils__t_Bytes.
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__handshake_data__impl__HandshakeData__to_two(
-         self : t13__tls13formats__handshake_data__t_HandshakeData
+letfun t13__tls13crypto__kem_keygen(
+         alg : t13__tls13crypto__t_KemScheme, rng : impl_CryptoRng___RngCore
        ) =
-       bitstring_default().
+       new kem_sk: t13__tls13utils__t_Bytes;
+       let kem_pk = kem_pk_from_sk(kem_sk) in
+       (rng, (kem_sk, kem_pk)).
+
+fun kem_encapsulation(t13__tls13utils__t_Bytes, t13__tls13utils__t_Bytes): t13__tls13utils__t_Bytes.
+
+letfun t13__tls13crypto__kem_encap(
+      alg: t13__tls13crypto__t_KemScheme,
+      pk: t13__tls13utils__t_Bytes,
+      rng: impl_CryptoRng___RngCore
+    ) = 
+     new shared_secret: t13__tls13utils__t_Bytes;
+     let ct = kem_encapsulation(pk, shared_secret) in
+     (rng,(shared_secret, ct)).
+
+reduc forall alg: t13__tls13crypto__t_KemScheme, kem_sk: t13__tls13utils__t_Bytes, shared_secret: t13__tls13utils__t_Bytes;
+     t13__tls13crypto__kem_decap(
+     alg, kem_encapsulation(kem_pk_from_sk(kem_sk), shared_secret), kem_sk
+     ) = shared_secret.
+(* MARKER: tls13crypto models end*)
+
+fun HandshakeData_to_bytes(t13__tls13formats__handshake_data__t_HandshakeData): t13__tls13utils__t_Bytes [typeConverter].
+fun HandshakeData_from_bytes(t13__tls13utils__t_Bytes):  t13__tls13formats__handshake_data__t_HandshakeData [typeConverter].
+
+letfun t13__tls13formats__handshake_data__impl__HandshakeData__concat(
+      self: t13__tls13formats__handshake_data__t_HandshakeData,
+      other: t13__tls13formats__handshake_data__t_HandshakeData
+    ) =
+
+
+    let self_bytes: t13__tls13utils__t_Bytes =          HandshakeData_to_bytes(self) in
+
+    let other_bytes: t13__tls13utils__t_Bytes =         HandshakeData_to_bytes(other) in
+
+    HandshakeData_from_bytes(
+    t13__tls13utils__impl__Bytes__concat(
+    self_bytes,
+    other_bytes
+    )).
+
+
 
 (* marked as constructor *)
 fun t13__tls13formats__certificate_verify(
@@ -2832,16 +2948,6 @@
     : t13__tls13formats__handshake_data__t_HandshakeData [data].
 
 (* marked as constructor *)
-fun t13__tls13formats__client_hello(
-      t13__tls13crypto__t_Algorithms,
-      t13__tls13utils__t_Bytes,
-      t13__tls13utils__t_Bytes,
-      t13__tls13utils__t_Bytes,
-      Option
-    )
-    : bitstring [data].
-
-(* marked as constructor *)
 fun t13__tls13formats__encrypted_extensions(t13__tls13crypto__t_Algorithms
     )
     : t13__tls13formats__handshake_data__t_HandshakeData [data].
@@ -2850,45 +2956,6 @@
 fun t13__tls13formats__finished(t13__tls13utils__t_Bytes)
     : t13__tls13formats__handshake_data__t_HandshakeData [data].
 
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__parse_certificate_verify(
-         algs : t13__tls13crypto__t_Algorithms,
-         certificate_verify : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       t13__tls13utils__t_Bytes_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__parse_client_hello(
-         ciphersuite : t13__tls13crypto__t_Algorithms,
-         client_hello : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       bitstring_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__parse_encrypted_extensions(
-         v__algs : t13__tls13crypto__t_Algorithms,
-         encrypted_extensions : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       bitstring_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__parse_finished(
-         finished : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       t13__tls13utils__t_Bytes_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__parse_server_certificate(
-         certificate : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       t13__tls13utils__t_Bytes_default().
-
-(* REPLACE by handwritten model *)
-letfun t13__tls13formats__parse_server_hello(
-         algs : t13__tls13crypto__t_Algorithms,
-         server_hello : t13__tls13formats__handshake_data__t_HandshakeData
-       ) =
-       bitstring_default().
 
 (* marked as constructor *)
 fun t13__tls13formats__server_certificate(
@@ -2904,15 +2971,134 @@
       t13__tls13utils__t_Bytes
     )
     : t13__tls13formats__handshake_data__t_HandshakeData [data].
+(* MARKER: tls13formats models*)
+
+reduc forall hs1: t13__tls13utils__t_Bytes,
+             hs2: t13__tls13utils__t_Bytes;
+  t13__tls13formats__handshake_data__impl__HandshakeData__to_two(
+                HandshakeData_from_bytes(t13__tls13utils__impl__Bytes__concat(hs1, hs2)))
+     = (hs1,
+        hs2).
+
+
+reduc forall hs1: t13__tls13utils__t_Bytes,
+             hs2: t13__tls13utils__t_Bytes,
+             hs3: t13__tls13utils__t_Bytes,
+             hs4: t13__tls13utils__t_Bytes;
+  t13__tls13formats__handshake_data__impl__HandshakeData__to_four(
+                HandshakeData_from_bytes(t13__tls13utils__impl__Bytes__concat(
+                        t13__tls13utils__impl__Bytes__concat(
+                                t13__tls13utils__impl__Bytes__concat(
+                                hs1,
+                                hs2),
+                                hs3),
+                                hs4)))
+     = (hs1,
+        hs2,
+        hs3,
+        hs4).
+
+reduc forall algs: t13__tls13crypto__t_Algorithms, cert: t13__tls13utils__t_Bytes;
+      t13__tls13formats__parse_certificate_verify(
+        algs,t13__tls13formats__certificate_verify(algs, cert)
+      ) = cert.
+
+reduc forall   algs: t13__tls13crypto__t_Algorithms, server_random: t13__tls13utils__t_Bytes, sid: t13__tls13utils__t_Bytes, gy: t13__tls13utils__t_Bytes;
+   t13__tls13formats__parse_server_hello(
+     algs,
+     t13__tls13formats__server_hello(algs, server_random, sid, gy)
+) = (server_random, gy).
+
+reduc forall algs: t13__tls13crypto__t_Algorithms;
+      t13__tls13formats__parse_encrypted_extensions(
+        algs,
+        t13__tls13formats__encrypted_extensions(algs)
+      ) = ().
+
+reduc forall vd: t13__tls13utils__t_Bytes;
+   t13__tls13formats__parse_finished(
+     t13__tls13formats__finished(vd)
+) = vd.
+
+reduc forall algs: t13__tls13crypto__t_Algorithms, cert: t13__tls13utils__t_Bytes;
+  t13__tls13formats__parse_server_certificate(
+     t13__tls13formats__server_certificate(algs, cert)
+  ) = cert.
+
+fun client_hello_c(
+      t13__tls13utils__t_Bytes, (* client_randomness *)
+      t13__tls13utils__t_Bytes, (* session_id *)
+      t13__tls13utils__t_Bytes, (*server name /sni*)
+      t13__tls13utils__t_Bytes, (*kem_pk / gx*)
+      Option, (*tkto*)
+      Option, (*bindero*)
+      nat) (*trunc_len*)
+      : t13__tls13formats__handshake_data__t_HandshakeData [data].
+
+letfun t13__tls13formats__client_hello(
+      alg: t13__tls13crypto__t_Algorithms,
+      client_random: t13__tls13utils__t_Bytes,
+      kem_pk: t13__tls13utils__t_Bytes,
+      server_name: t13__tls13utils__t_Bytes,
+      session_ticket: Option
+    ) =
+    (client_hello_c(client_random,
+                            t13__tls13utils__t_Bytes_default(),
+                            server_name,
+                            kem_pk,
+                            session_ticket,
+                            None(),
+                            0),
+     0).
 
-(* REPLACE by handwritten model *)
 letfun t13__tls13formats__set_client_hello_binder(
          ciphersuite : t13__tls13crypto__t_Algorithms,
          binder : Option,
          client_hello : t13__tls13formats__handshake_data__t_HandshakeData,
          trunc_len : Option
        ) =
-       t13__tls13formats__handshake_data__t_HandshakeData_default().
+       let client_hello_c(client_randomness,
+                                  session_id,
+                                  server_name,
+                                  kem_pk,
+                                  tkto,
+                                  old_binder,
+                                  old_trunc_len)
+        = client_hello in
+          client_hello_c(client_randomness,
+                                  session_id,
+                                  server_name,
+                                  kem_pk,
+                                  tkto,
+                                  binder,
+                                  0).
+
+fun t13__tls13formats__parse_client_hello(t13__tls13crypto__t_Algorithms, t13__tls13formats__handshake_data__t_HandshakeData): bitstring
+reduc forall
+      algs:t13__tls13crypto__t_Algorithms,
+      client_random: t13__tls13utils__t_Bytes,
+      server_name: t13__tls13utils__t_Bytes,
+      kem_pk: t13__tls13utils__t_Bytes,
+      session_ticket: Option,
+      binder: Option;
+    t13__tls13formats__parse_client_hello(
+        algs,
+        client_hello_c(client_random,
+                            t13__tls13utils__t_Bytes_default_value,
+                            server_name,
+                            kem_pk,
+                            session_ticket,
+                            binder,
+                            0))
+           = (client_random,
+                            t13__tls13utils__t_Bytes_default_value,
+                            server_name,
+                            kem_pk,
+                            session_ticket,
+                            binder,
+                            0).
+(* MARKER: tls13formats models end*)
+
 
 letfun t13__tls13handshake__get_rsa_signature(
          cert : t13__tls13utils__t_Bytes,
@@ -2950,12 +3136,16 @@
        ) =
        t13__tls13crypto__AeadKeyIV_c(key,iv).
 
-(* marked as constructor *)
-fun t13__tls13formats__impl__Transcript__add(
-      t13__tls13formats__t_Transcript,
-      t13__tls13formats__handshake_data__t_HandshakeData
-    )
-    : t13__tls13formats__t_Transcript [data].
+letfun t13__tls13formats__impl__Transcript__add(
+    old_transcript:       t13__tls13formats__t_Transcript,
+    addition:       t13__tls13formats__handshake_data__t_HandshakeData
+    ) =
+    let        t13__tls13formats__Transcript_c(hash_algorithm: t13__tls13crypto__t_HashAlgorithm, old_handshake_data: t13__tls13formats__handshake_data__t_HandshakeData) = old_transcript in
+        t13__tls13formats__Transcript_c(
+         hash_algorithm
+         ,
+         t13__tls13formats__handshake_data__HandshakeData_c(HandshakeData_to_bytes(t13__tls13formats__handshake_data__impl__HandshakeData__concat(old_handshake_data, addition)))
+    ).
 
 letfun t13__tls13formats__impl__Transcript__new(
          hash_algorithm : t13__tls13crypto__t_HashAlgorithm
@@ -2980,13 +3170,35 @@
        ) in th
        else t13__tls13utils__t_Bytes_err().
 
+fun transcript_to_bytes(t13__tls13formats__t_Transcript): t13__tls13utils__t_Bytes [typeConverter].
+
 (* marked as constructor *)
 fun t13__tls13formats__impl__Transcript__transcript_hash_without_client_hello(
       t13__tls13formats__t_Transcript,
       t13__tls13formats__handshake_data__t_HandshakeData,
       nat
     )
-    : t13__tls13utils__t_Bytes [data].
+    : t13__tls13utils__t_Bytes
+reduc forall tx: t13__tls13formats__t_Transcript,
+            cr: t13__tls13utils__t_Bytes,
+            sid: t13__tls13utils__t_Bytes,
+            server_name: t13__tls13utils__t_Bytes,
+            kem_pk: t13__tls13utils__t_Bytes,
+            ticket: Option,
+            binder: Option,
+             trunc_len: nat;
+      t13__tls13formats__impl__Transcript__transcript_hash_without_client_hello(
+        tx,
+        client_hello_c(
+            cr,
+            sid,
+            server_name,
+            kem_pk,
+            ticket,
+            binder,
+            trunc_len),
+         trunc_len) = transcript_to_bytes(tx).
+
 
 letfun t13__tls13handshake__derive_aead_key_iv(
          hash_algorithm : t13__tls13crypto__t_HashAlgorithm,
@@ -3485,6 +3697,7 @@
        else (t13__tls13handshake__t_ClientPostCertificateVerify_err()).
 
 letfun t13__tls13handshake__put_server_signature(
+         server_name: t13__tls13utils__t_Bytes,
          encrypted_extensions : t13__tls13formats__handshake_data__t_HandshakeData,
          server_certificate : t13__tls13formats__handshake_data__t_HandshakeData,
          server_certificate_verify : t13__tls13formats__handshake_data__t_HandshakeData,
@@ -3527,7 +3740,7 @@
               ) in let spki = t13__tls13cert__verification_key_from_cert(
                 certificate
               ) in let cert_pk = t13__tls13cert__cert_public_key(
-                certificate, spki
+                server_name, certificate, spki
               ) in let cert_signature = t13__tls13formats__parse_certificate_verify(
                 algorithms, server_certificate_verify
               ) in (
@@ -4003,6 +4216,7 @@
        else bitstring_err().
 
 letfun t13__tls13handshake__client_finish(
+         server_name: t13__tls13utils__t_Bytes,
          payload : t13__tls13formats__handshake_data__t_HandshakeData,
          handshake_state : t13__tls13handshake__t_ClientPostServerHello
        ) =
@@ -4016,6 +4230,7 @@
        ) = t13__tls13formats__handshake_data__impl__HandshakeData__to_four(
          payload
        ) in let client_state_certificate_verify = t13__tls13handshake__put_server_signature(
+         server_name,
          encrypted_extensions,
          server_certificate,
          server_certificate_verify,
@@ -4030,7 +4245,8 @@
          client_state: t13__tls13handshake__t_ClientPostClientFinished
        ) = t13__tls13handshake__get_client_finished(
          client_state_server_finished
-       ) in (client_finished, cipher, client_state)
+       ) in
+       (client_finished, cipher, client_state)
        else bitstring_err()
        else bitstring_err()
        else bitstring_err()
